<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>RE Solution - Gest√£o Financeira Pro</title>

<meta name="theme-color" content="#6366f1">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="logo.png">
<link rel="icon" type="image/png" href="logo.png">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: 1px solid rgba(255, 255, 255, 0.5);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    
    --text-dark: #1e293b;
    --text-light: #64748b;
    
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;

    --input-bg: rgba(255, 255, 255, 0.6);
  }

  body.dark-mode {
    --text-dark: #f1f5f9;
    --text-light: #cbd5e1;
    --glass-bg: rgba(15, 23, 42, 0.6);
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);
    --input-bg: rgba(0, 0, 0, 0.3);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    font-family: 'Poppins', sans-serif; 
    margin: 0; display: flex; height: 100vh; 
    color: var(--text-dark); overflow: hidden; 
    background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
    background-size: 400% 400%;
    animation: blushAnimation 15s ease infinite;
    transition: background 0.5s;
  }
  
  body.dark-mode { background: linear-gradient(-45deg, #1e1b4b, #312e81, #4c1d95, #1e1b4b); background-size: 400% 400%; animation: blushAnimation 15s ease infinite; }

  @keyframes blushAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

  /* SIDEBAR */
  .sidebar { 
    width: 80px; background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-right: var(--glass-border); display: flex; flex-direction: column; 
    padding: 25px 15px; flex-shrink: 0; z-index: 100; overflow-x: hidden; overflow-y: auto;
    transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  .sidebar:hover { width: 280px; }
  body.dark-mode .sidebar { background: rgba(15, 23, 42, 0.8); }

  /* LOGO AJUSTADO */
  .logo { 
    padding: 12px; margin-bottom: 25px; display: flex; align-items: center;
    overflow: hidden; white-space: nowrap; color: #000000;
    font-size: 1.3rem; font-weight: 700;
  }
  .logo img {
    height: 28px; width: auto; min-width: 25px; object-fit: contain; margin-right: 10px;
  }
  .logo span { opacity: 0; transition: 0.3s; transform: translateX(-10px); display: inline-block; }
  .sidebar:hover .logo span { opacity: 1; transform: translateX(0); }

  .sidebar-section { margin-bottom: 25px; width: 100%; transition: 0.3s; }
  .sidebar-label { font-size: 0.75rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; white-space: nowrap; opacity: 0; transition: 0.2s; }
  .sidebar:hover .sidebar-label { opacity: 1; }
  .sidebar select, .sidebar input { opacity: 0; pointer-events: none; transition: 0.2s; }
  .sidebar:hover select, .sidebar:hover input { opacity: 1; pointer-events: auto; }
  #containerGraficoSide { opacity: 0; transition: 0.2s; visibility: hidden; }
  .sidebar:hover #containerGraficoSide { opacity: 1; visibility: visible; transition-delay: 0.2s; }

  .sidebar .btn-outline { display: flex; align-items: center; justify-content: flex-start; padding: 12px; white-space: nowrap; overflow: hidden; }
  .sidebar .btn-outline i { min-width: 25px; text-align: center; margin-right: 10px; font-size: 1.1rem; }
  .sidebar .btn-outline span { opacity: 0; transform: translateX(-10px); transition: 0.3s; }
  .sidebar:hover .btn-outline span { opacity: 1; transform: translateX(0); }

  /* MAIN CONTENT */
  .main-content { flex: 1; padding: 30px; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; }
  
  .card { 
    background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-radius: 20px; padding: 25px; box-shadow: var(--glass-shadow); border: var(--glass-border);
    margin-bottom: 20px; position: relative; overflow: hidden;
  }
  
  .dash-card { position: relative; overflow: hidden; color: #fff; border: none !important; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
  .dash-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  .dash-card:active { transform: scale(0.98); }
  .click-hint { position: absolute; top: 12px; right: 15px; font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 12px; backdrop-filter: blur(5px); z-index: 3; }
  .dash-card label { font-size: 0.9rem; opacity: 0.9; font-weight: 600; letter-spacing: 0.5px; position: relative; z-index: 2; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .dash-card .dash-value { font-size: 1.8rem; font-weight: 700; margin-top: 5px; position: relative; z-index: 2; text-shadow: 0 2px 10px rgba(0,0,0,0.2); color: white !important; }
  .dash-bg-icon { position: absolute; right: -10px; bottom: -15px; font-size: 5rem; opacity: 0.2; transform: rotate(-15deg); z-index: 1; transition: 0.3s; }
  .dash-card:hover .dash-bg-icon { transform: rotate(0deg) scale(1.1); opacity: 0.3; }

  .card-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
  .card-danger { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }
  .card-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }
  .card-reserva { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); }

  /* Grid Systems */
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

  .desktop-only { display: block; } .mobile-only { display: none; }
  @media (max-width: 1024px) {
    .desktop-only { display: none !important; } .mobile-only { display: block !important; }
    .sidebar { display: none; } 
    .main-content { padding: 20px; padding-bottom: 90px; }
    .grid-4, .grid-2 { grid-template-columns: 1fr; gap: 15px; } 
  }

  /* INPUTS */
  input, select { width: 100%; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.4); border-radius: 12px; font-size: 0.95rem; background: var(--input-bg); color: var(--text-dark); outline: none; transition: 0.3s; font-family: 'Poppins', sans-serif; }
  input:focus, select:focus { background: rgba(255,255,255,0.9); border-color: #a855f7; box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2); }
  select option { background-color: #ffffff; color: #1e293b; }
  
  body.dark-mode input, body.dark-mode select {
    background-color: #1e293b !important;
    color: #ffffff !important;
    border-color: rgba(255,255,255,0.2);
  }
  body.dark-mode select option { background-color: #1e293b; color: #f1f5f9; }

  button { padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; transition: 0.3s; font-family: 'Poppins', sans-serif; }
  button:active { transform: scale(0.96); }
  .btn-primary { background: var(--primary-gradient); color: white; width: 100%; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
  .btn-outline { background: transparent; border: 1px solid var(--text-light); color: var(--text-light); width: 100%; margin-bottom: 5px; }
  .btn-outline:hover { background: rgba(255,255,255,0.2); border-color: var(--text-dark); color: var(--text-dark); }
  .btn-action { width: 32px; height: 32px; padding: 0; border-radius: 8px; font-size: 0.9rem; margin-left: 2px; }
  .btn-edit { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
  .btn-del { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
  
  .btn-green { background: var(--success); color: white; width: 100%; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
  .btn-red { background: var(--danger); color: white; width: 100%; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }

  .perfil-avatar { width: 45px; height: 45px; border-radius: 50%; overflow: hidden; cursor: pointer; border: 2px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; background: #e2e8f0; }
  .perfil-avatar:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3); border-color: #a855f7; }
  .perfil-avatar img { width: 100%; height: 100%; object-fit: cover; }

  .table-box { width: 100%; overflow-x: hidden; }
  table { width: 100%; border-collapse: collapse; table-layout: fixed; }
  th { text-align: left; padding: 10px 5px; color: #8b5cf6; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid rgba(0,0,0,0.05); }
  td { padding: 10px 5px; border-bottom: 1px solid rgba(0,0,0,0.05); color: var(--text-dark); font-size: 0.85rem; vertical-align: middle; }
  th:nth-child(1), td:nth-child(1) { width: auto; }
  .desc-text { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
  @media (min-width: 500px) { .desc-text { max-width: 200px; } }
  th:nth-child(2), td:nth-child(2) { width: 25%; text-align: right; }
  th:nth-child(3), td:nth-child(3) { width: 18%; text-align: center; }
  @media (max-width: 400px) { th:nth-child(3), td:nth-child(3) { display: none; } } 
  th:nth-child(4), td:nth-child(4) { width: 35px; text-align: center; }
  th:nth-child(5), td:nth-child(5) { width: 75px; text-align: right; }

  .custom-check { appearance: none; width: 18px; height: 18px; border: 2px solid var(--text-light); border-radius: 6px; cursor: pointer; position: relative; margin: 0; }
  .custom-check:checked { background: var(--success); border-color: var(--success); }
  .custom-check:checked::after { content: '‚úî'; color: white; position: absolute; font-size: 12px; top: -1px; left: 2px; }

  .row-category { background: rgba(0,0,0,0.03); cursor: pointer; transition: background 0.2s; }
  .row-category:hover { background: rgba(0,0,0,0.06); }
  body.dark-mode .row-category { background: rgba(255,255,255,0.03); }
  body.dark-mode .row-category:hover { background: rgba(255,255,255,0.06); }
  
  .cat-title-wrapper { display: flex; align-items: center; gap: 6px; }
  .badge-pendente { font-size: 0.65rem; background: rgba(245, 158, 11, 0.15); color: var(--warning); padding: 3px 8px; border-radius: 12px; margin-left: 8px; vertical-align: middle; font-weight: 600; text-transform: none; display: inline-flex; align-items: center; gap: 4px; border: 1px solid rgba(245, 158, 11, 0.3); letter-spacing: 0; }
  .dot-pendente { color: var(--warning); font-size: 0.5rem; animation: pulseDot 2s infinite; }
  @keyframes pulseDot { 0% { opacity: 0.6; } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.6; } }

  .tip-card { background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%); border: 1px dashed rgba(168, 85, 247, 0.5); border-radius: 16px; padding: 12px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; }
  body.dark-mode .tip-card { background: rgba(255, 255, 255, 0.03); }
  .tip-icon { font-size: 1.4rem; color: #a855f7; animation: bounceTip 2s infinite ease-in-out; }
  @keyframes bounceTip { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
  .tip-text-container { flex: 1; overflow: hidden; display: flex; align-items: center; }
  .tip-text { font-size: 0.85rem; color: var(--text-dark); font-weight: 500; transition: opacity 0.5s ease, transform 0.5s ease; width: 100%; }
  .tip-hidden { opacity: 0; transform: translateY(5px); }

  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; }
  .modal-content { background: #fff; width: 90%; max-width: 500px; border-radius: 24px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 85vh; }
  body.dark-mode .modal-content { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); }
  .modal-header { background: var(--primary-gradient); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
  .modal-body { padding: 20px; overflow-y: auto; }
  
  .insight-card { padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
  .insight-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
  .item-list { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed rgba(0,0,0,0.1); font-size: 0.9rem; }
  #bannerAlerta { display: none; background: rgba(239, 68, 68, 0.9); backdrop-filter: blur(5px); color: white; text-align: center; padding: 10px; font-weight: 600; font-size: 0.9rem; position: fixed; top: 0; left: 0; right: 0; z-index: 200; }

  .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid rgba(255,255,255,0.5); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
  body.dark-mode .bottom-nav { background: rgba(30, 41, 59, 0.9); }
  .nav-btn { background: none; border: none; color: var(--text-light); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; cursor: pointer; padding: 5px; flex: 1; }
  .nav-btn i { font-size: 1.4rem; transition: 0.2s; }
  .nav-btn span { font-weight: 500; }
  .nav-btn:active i { transform: scale(0.9); color: #8b5cf6; }
  .nav-btn-main { background: var(--primary-gradient); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -30px; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); border: 4px solid rgba(255,255,255,0.8); }
  body.dark-mode .nav-btn-main { border-color: #1e1b4b; }
  .text-success { color: var(--success); }
  .text-danger { color: var(--danger); }
  .vencido { color: var(--danger); font-weight: 700; }

  /* Popup Mobile */
  #areaFormulario { display: block; }
  @media (max-width: 1024px) {
      #areaFormulario { display: none; }
      #areaFormulario.mobile-popup { display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); z-index: 5000; align-items: flex-end; justify-content: center; padding: 0; margin: 0; border-radius: 0; border: none; }
      #areaFormulario.mobile-popup .form-content { background: #fff; width: 100%; border-radius: 24px 24px 0 0; padding: 25px; box-shadow: 0 -10px 40px rgba(0,0,0,0.3); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); border: 1px solid rgba(0,0,0,0.05); position: relative; }
      body.dark-mode #areaFormulario.mobile-popup .form-content { background: #1e293b; border-color: rgba(255,255,255,0.1); }
  }
  @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .btn-close-form { display: none; position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.05); border: none; width: 30px; height: 30px; border-radius: 50%; color: var(--text-light); font-size: 1rem; cursor: pointer; }
  body.dark-mode .btn-close-form { background: rgba(255,255,255,0.1); color: #fff; }
</style>
</head>
<body>

<div id="bannerAlerta">üîî ATEN√á√ÉO: Contas vencidas ou vencendo hoje!</div>

<div class="sidebar d-none d-lg-flex">
  <div class="logo">
    <img src="logo.png" alt="Logo" class="logo-img"> 
    <span>RE Solution</span>
</div>
  
  <div class="sidebar-section">
    <div class="sidebar-label">M√™s</div>
    <select id="mes" onchange="mudarMes()">
      <option value="2026-01">Janeiro/2026</option>
      <option value="2026-02">Fevereiro/2026</option>
      <option value="2026-03">Mar√ßo/2026</option>
      <option value="2026-04">Abril/2026</option>
      <option value="2026-05">Maio/2026</option>
      <option value="2026-06">Junho/2026</option>
      <option value="2026-07">Julho/2026</option>
      <option value="2026-08">Agosto/2026</option>
      <option value="2026-09">Setembro/2026</option>
      <option value="2026-10">Outubro/2026</option>
      <option value="2026-11">Novembro/2026</option>
      <option value="2026-12">Dezembro/2026</option>
    </select>
  </div>

  <div class="sidebar-section desktop-only" id="containerGraficoSide">
    <div class="sidebar-label">Resumo Visual</div>
    <div style="height: 180px; position: relative;">
      <canvas id="graficoSidebar"></canvas>
    </div>
  </div>

  <div class="sidebar-section" style="margin-top:auto;">
    <div class="sidebar-label">Sistema</div>
    
    <button class="btn-outline" onclick="gerarRelatorioDiario()">
        <i class="fas fa-chart-line"></i> <span>Relat√≥rio</span>
    </button>
    <button class="btn-outline" onclick="exportarDados()">
        <i class="fas fa-file-export"></i> <span>Backup</span>
    </button>
    <button class="btn-outline" onclick="toggleDarkMode()">
        <i class="fas fa-adjust"></i> <span>Tema</span>
    </button>
    <button class="btn-outline" onclick="window.fazerLogout()" style="color: var(--danger); border-color: var(--danger);">
        <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
    </button>
  </div>
</div>

<main class="main-content" id="top">
  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
      <h2 style="margin:0; font-size: 1.5rem;">Vis√£o Geral</h2>
      <span id="labelMesAtivo" style="color: var(--text-light); font-weight: 500;">Carregando...</span>
    </div>
    
    <div class="perfil-wrapper">
        <div class="perfil-avatar">
            <img id="imgPerfil" src="https://ui-avatars.com/api/?name=User&background=random" alt="Perfil">
        </div>
    </div>
  </div>

  <div class="tip-card">
      <i class="fas fa-lightbulb tip-icon"></i>
      <div class="tip-text-container">
          <div id="tipText" class="tip-text">Carregando dica...</div>
      </div>
  </div>

  <div class="grid-4">
    <div class="card dash-card card-success" onclick="abrirRelatorioCard('receber')">
      <span class="click-hint"><i class="fas fa-search"></i> Resumo</span>
      <i class="fas fa-arrow-down dash-bg-icon"></i>
      <label>Recebido</label>
      <div class="dash-value" id="totalRecebido">R$ 0,00</div>
    </div>
    
    <div class="card dash-card card-danger" onclick="abrirRelatorioCard('pagar')">
      <span class="click-hint"><i class="fas fa-search"></i> Resumo</span>
      <i class="fas fa-arrow-up dash-bg-icon"></i>
      <label>Pago</label>
      <div class="dash-value" id="totalPago">R$ 0,00</div>
    </div>
    
    <div class="card dash-card card-reserva" onclick="abrirRelatorioCard('reserva')">
      <span class="click-hint"><i class="fas fa-search"></i> Detalhes</span>
      <i class="fas fa-piggy-bank dash-bg-icon"></i>
      <label>Reserva (Total)</label>
      <div class="dash-value" id="totalReserva">R$ 0,00</div>
    </div>

    <div class="card dash-card card-primary" onclick="abrirRelatorioCard('saldo')">
      <span class="click-hint"><i class="fas fa-search"></i> Resumo</span>
      <i class="fas fa-wallet dash-bg-icon"></i>
      <label>Saldo Dispon√≠vel</label>
      <div class="dash-value" id="saldo">R$ 0,00</div>
    </div>
  </div>

  <div class="card mobile-only" style="margin-top: 20px;">
    <h3 style="margin-top:0; margin-bottom: 15px; font-size: 1rem; color: var(--text-light); text-transform: uppercase;">üìä Resumo de Gastos</h3>
    <div style="height: 250px; position: relative;">
      <canvas id="graficoMobile"></canvas>
    </div>
  </div>

  <div id="areaFormulario" class="card" style="margin-top: 20px;">
    <div class="form-content">
        <button class="btn-close-form mobile-only" onclick="fecharFormularioMobile()" style="display:block">‚úï</button>
        <h3 style="margin-top:0; margin-bottom: 15px;">üìù Novo Lan√ßamento</h3>
        <div class="grid-2">
          <div>
            <label>Tipo</label>
            <select id="tipo">
              <option value="pagar">üî¥ Pagar (Sa√≠da)</option>
              <option value="receber">üü¢ Receber (Entrada)</option>
            </select>
          </div>
          <div>
            <label>Categoria</label>
            <select id="categoria">
                <option value="Supermercado">üõí Supermercado</option>
                <option value="Alimenta√ß√£o">üçî Alimenta√ß√£o</option>
                <option value="Transporte">üöó Transporte</option>
                <option value="Lazer">üéâ Lazer</option>
                <option value="Gastos Pessoais">üíÜ‚Äç‚ôÇÔ∏è Gastos Pessoais</option>
                <option value="Sa√∫de">ü©∫ Sa√∫de e bem-estar</option>
                <option value="Credito">üí≤ Credito</option>
                <option value="Filho">üßí Filho</option>
                <option value="Moradia">üè† Moradia</option>
                <option value="Assinaturas">üì∫ Assinaturas</option>
                <option value="Emprestimos">üí∏ Emprestimos</option>
                <option value="Vale Alimenta√ß√£o">üí≥ Vale Alimenta√ß√£o</option>
                <option value="Mensalidades">üí™ Mensalidades</option>
                <option value="Reserva">üßæ Reserva (Envia p/ Card)</option>
                <option value="Resgate Reserva">üí∞ Resgate Reserva</option>
                <option value="Sal√°rio">üí∞ Sal√°rio</option>
                <option value="Outros">‚öôÔ∏è Outros</option>
            </select>
          </div>
        </div>
        <div class="grid-2">
          <div><label>Descri√ß√£o</label><input id="descricao" placeholder="Ex: Mercado Semanal"></div>
          <div><label>Valor (R$)</label><input id="valor" type="number" step="0.01"></div>
        </div>
        <div style="margin-bottom: 15px;"><label>Data</label><input id="data" type="date"></div>
        <button id="btnSalvar" class="btn-primary" onclick="adicionar()">
          <i class="fas fa-plus-circle"></i> Adicionar Lan√ßamento
        </button>
    </div>
  </div>

  <div class="grid-2">
    <div class="card">
      <h3 class="text-success" style="margin-top:0" id="tituloReceber"><i class="fas fa-arrow-down"></i> Entradas</h3>
      <div class="table-box">
        <table>
          <thead><tr><th>Categoria/Desc.</th><th>Valor</th><th>Data</th><th>OK</th><th></th></tr></thead>
          <tbody id="tabelaReceber"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 class="text-danger" style="margin-top:0" id="tituloPagar"><i class="fas fa-arrow-up"></i> Sa√≠das</h3>
      <div class="table-box">
        <table>
          <thead><tr><th>Categoria/Desc.</th><th>Valor</th><th>Data</th><th>OK</th><th></th></tr></thead>
          <tbody id="tabelaPagar"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="height: 50px;"></div> 
</main>

<nav class="bottom-nav" id="navMobile">
  <button class="nav-btn" onclick="scrollToId('top')">
    <i class="fas fa-home"></i> <span>In√≠cio</span>
  </button>
  <button class="nav-btn" onclick="gerarRelatorioDiario()">
    <i class="fas fa-chart-pie"></i> <span>Relat√≥rio</span>
  </button>
  
  <button class="nav-btn-main" onclick="abrirFormularioMobile()">
    <i class="fas fa-plus"></i>
  </button>
  
  <button class="nav-btn" onclick="abrirConfigMobile()">
    <i class="fas fa-calendar-alt"></i> <span>M√™s</span>
  </button>
  <button class="nav-btn" onclick="window.fazerLogout()" style="color:var(--danger)">
    <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
  </button>
</nav>

<div id="modalConfig" class="modal-overlay" onclick="fecharModalGeral(event, 'modalConfig')">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">Selecionar Per√≠odo</h3>
      <button onclick="document.getElementById('modalConfig').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem;">‚úï</button>
    </div>
    <div class="modal-body">
      <label>Selecionar M√™s</label>
      <select id="mesMobile" onchange="mudarMesMobile()" style="margin-bottom: 20px;">
        <option value="2026-01">Janeiro/2026</option>
        <option value="2026-02">Fevereiro/2026</option>
        <option value="2026-03">Mar√ßo/2026</option>
        <option value="2026-04">Abril/2026</option>
        <option value="2026-05">Maio/2026</option>
        <option value="2026-06">Junho/2026</option>
        <option value="2026-07">Julho/2026</option>
        <option value="2026-08">Agosto/2026</option>
        <option value="2026-09">Setembro/2026</option>
        <option value="2026-10">Outubro/2026</option>
        <option value="2026-11">Novembro/2026</option>
        <option value="2026-12">Dezembro/2026</option>
      </select>

      <label>Dados</label>
      <button class="btn-outline" style="color:var(--text-dark); border-color:var(--text-light);" onclick="exportarDados()">Baixar Backup</button>
      <button class="btn-outline" style="color:var(--text-dark); border-color:var(--text-light);" onclick="toggleDarkMode()">Mudar Tema</button>
    </div>
  </div>
</div>

<div id="modalRelatorio" class="modal-overlay" onclick="fecharModalGeral(event, 'modalRelatorio')">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0" id="modalRelatorioTitulo">üìä Relat√≥rio</h3>
      <button onclick="document.getElementById('modalRelatorio').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">‚úï</button>
    </div>
    <div id="corpoRelatorio" class="modal-body"></div>
  </div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ----------------------------------------------------
    // VARI√ÅVEIS GLOBAIS (Acess√≠veis pelo HTML)
    // ----------------------------------------------------
    window.usuarioLogado = null;
    window.dadosPorMes = {};
    window.mesSelecionado = localStorage.getItem('mesSelecionado') || '2026-01';
    window.mesAtual = window.mesSelecionado;
    window.editandoIndex = null;
    window.editandoTipo = null;
    window.categoriasExpandidas = { receber: {}, pagar: {} };
    
    // Dicas
    const dicasFinanceiras = [
        "Regra 50/30/20: 50% Essencial, 30% Lazer, 20% Futuro.",
        "Reserva de Emerg√™ncia: Tenha 6 meses de gastos guardados.",
        "Pague-se primeiro: Invista assim que receber o sal√°rio.",
        "Juros compostos s√£o seus amigos no longo prazo.",
        "Evite compras por impulso. Espere 24h.",
        "Cancele assinaturas que voc√™ n√£o usa."
    ];
    let dicaAtual = 0;

    // ----------------------------------------------------
    // 1. MONITORAMENTO DE LOGIN (Substitui window.onload antigo)
    // ----------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("Usu√°rio detectado:", user.email);
            window.usuarioLogado = user;
            if(user.photoURL) document.getElementById('imgPerfil').src = user.photoURL;

            // CARREGAR DO FIRESTORE
            const docRef = doc(db, "usuarios", user.uid);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    window.dadosPorMes = docSnap.data().financeiro || {};
                } else {
                    // Primeiro acesso: tenta migrar localStorage ou cria vazio
                    const dadosLocais = localStorage.getItem('financeiroDados2026');
                    if (dadosLocais) {
                        window.dadosPorMes = JSON.parse(dadosLocais);
                        salvarNaNuvem(); // Sobe o backup local para a nuvem
                    } else {
                        window.dadosPorMes = {};
                    }
                }
            } catch (error) {
                console.error("Erro ao buscar dados:", error);
                alert("Erro de conex√£o com a nuvem. Tentando usar dados locais...");
                window.dadosPorMes = JSON.parse(localStorage.getItem('financeiroDados2026') || '{}');
            }

            // Inicializa a tela ap√≥s carregar dados
            inicializarApp();

        } else {
            // Se n√£o estiver logado, manda pro login
            window.location.href = "login.html";
        }
    });

    function inicializarApp() {
        document.getElementById('mes').value = window.mesAtual;
        if(document.getElementById('mesMobile')) document.getElementById('mesMobile').value = window.mesAtual;
        if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');
        
        iniciarSliderDicas();
        render();
        atualizarLabelTopo();
        const isMobile = window.innerWidth <= 1024;
        if(!isMobile) document.getElementById('navMobile').style.display = 'none';
    }

    // ----------------------------------------------------
    // 2. FUN√á√ÉO SALVAR (Nuvem + Local)
    // ----------------------------------------------------
    async function salvarNaNuvem() {
        try {
            await setDoc(doc(db, "usuarios", window.usuarioLogado.uid), {
                financeiro: window.dadosPorMes,
                ultimoAcesso: new Date().toISOString()
            });
        } catch (e) {
            console.error("Erro ao salvar na nuvem:", e);
        }
    }

    window.salvar = async function() {
        // Backup Local (r√°pido)
        localStorage.setItem('financeiroDados2026', JSON.stringify(window.dadosPorMes));
        
        // Salvar na Nuvem
        if (window.usuarioLogado) {
            await salvarNaNuvem();
        }
    }

    // ----------------------------------------------------
    // 3. FUN√á√ïES GLOBAIS DE INTERFACE (Bot√µes HTML chamam estas)
    // ----------------------------------------------------

    window.fazerLogout = () => {
        if(confirm("Deseja realmente sair?")) {
            signOut(auth).then(() => window.location.href = "login.html");
        }
    }

    window.garantirMes = () => { 
        if(!window.dadosPorMes[window.mesAtual]) window.dadosPorMes[window.mesAtual] = { receber: [], pagar: [] }; 
    }
    
    window.formatar = (v) => { 
        return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); 
    }

    window.atualizarLabelTopo = () => {
        const select = document.getElementById('mes');
        const texto = select.options[select.selectedIndex].text;
        document.getElementById('labelMesAtivo').innerText = texto;
    }

    window.mudarMes = () => {
        window.mesAtual = document.getElementById('mes').value;
        localStorage.setItem('mesSelecionado', window.mesAtual);
        if(document.getElementById('mesMobile')) document.getElementById('mesMobile').value = window.mesAtual;
        atualizarLabelTopo(); render();
    }

    window.mudarMesMobile = () => {
        window.mesAtual = document.getElementById('mesMobile').value;
        document.getElementById('mes').value = window.mesAtual;
        mudarMes(); document.getElementById('modalConfig').style.display = 'none';
    }

    window.abrirConfigMobile = () => { document.getElementById('modalConfig').style.display = 'flex'; }
    window.fecharModalGeral = (e, id) => { if(e.target.id === id) e.target.style.display = 'none'; }
    window.scrollToId = (id) => { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
    
    window.toggleDarkMode = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
        atualizarGrafico();
    }

    // Slider Dicas
    window.iniciarSliderDicas = function() {
        const tipEl = document.getElementById('tipText');
        if(!tipEl) return;
        tipEl.innerHTML = dicasFinanceiras[dicaAtual];
        
        // Limpar intervalos antigos se houver
        if(window.intervaloDicas) clearInterval(window.intervaloDicas);

        window.intervaloDicas = setInterval(() => {
            tipEl.classList.add('tip-hidden'); 
            setTimeout(() => {
                dicaAtual = (dicaAtual + 1) % dicasFinanceiras.length;
                tipEl.innerHTML = dicasFinanceiras[dicaAtual];
                tipEl.classList.remove('tip-hidden'); 
            }, 500); 
        }, 30000); 
    }

    // Fun√ß√µes de UI (Popups)
    window.abrirFormularioMobile = () => { document.getElementById('areaFormulario').classList.add('mobile-popup'); }
    window.fecharFormularioMobile = () => {
        document.getElementById('areaFormulario').classList.remove('mobile-popup');
        if(window.editandoIndex === null) {
            document.getElementById('descricao').value = '';
            document.getElementById('valor').value = '';
        }
    }

    // Transa√ß√£o de Reserva Direta
    window.realizarTransacaoReserva = (tipo) => {
        const input = document.getElementById('inputValorReserva');
        const valor = Number(input.value);
        if(!valor || valor <= 0) { alert("Digite um valor v√°lido."); return; }

        const hoje = new Date().toISOString().split('T')[0];
        window.garantirMes();

        if(tipo === 'depositar') {
            window.dadosPorMes[window.mesAtual].pagar.push({
                descricao: 'Aporte Reserva', valor: valor, data: hoje, categoria: 'Reserva', marcado: true
            });
            window.categoriasExpandidas['pagar']['Reserva'] = true;
        } else {
             window.dadosPorMes[window.mesAtual].receber.push({
                descricao: 'Resgate Reserva', valor: valor, data: hoje, categoria: 'Resgate Reserva', marcado: true
            });
            window.categoriasExpandidas['receber']['ResgateReserva'] = true;
        }
        window.salvar();
        window.render();
        window.abrirRelatorioCard('reserva');
    }

    // CRUD (Adicionar, Editar, Remover)
    window.adicionar = () => {
        const tipo = document.getElementById('tipo').value;
        const descricao = document.getElementById('descricao').value;
        const valor = Number(document.getElementById('valor').value);
        const data = document.getElementById('data').value;
        const categoria = document.getElementById('categoria').value;
        
        if(!descricao || !valor) return alert("Preencha descri√ß√£o e valor");
        window.garantirMes();
        
        const idSafe = categoria.replace(/[^a-zA-Z0-9]/g, '');
        window.categoriasExpandidas[tipo][idSafe] = true; 
        
        const item = {descricao, valor, data, categoria, marcado: false};
        if(window.editandoIndex !== null) { 
            item.marcado = window.dadosPorMes[window.mesAtual][window.editandoTipo][window.editandoIndex].marcado; 
            window.dadosPorMes[window.mesAtual][window.editandoTipo][window.editandoIndex] = item; 
        } else { 
            window.dadosPorMes[window.mesAtual][tipo].push(item); 
        }
        window.editandoIndex = null;
        document.getElementById('btnSalvar').innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Lan√ßamento';
        document.getElementById('descricao').value = ''; document.getElementById('valor').value = '';
        
        window.salvar(); window.render();
        window.fecharFormularioMobile();
    }

    window.prepararEdicao = (tipo, index) => {
        window.editandoIndex = index; window.editandoTipo = tipo;
        const item = window.dadosPorMes[window.mesAtual][tipo][index];
        document.getElementById('tipo').value = tipo; 
        document.getElementById('descricao').value = item.descricao;
        document.getElementById('valor').value = item.valor; 
        document.getElementById('data').value = item.data; 
        document.getElementById('categoria').value = item.categoria;
        document.getElementById('btnSalvar').innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√£o'; 
        
        const isMobile = window.innerWidth <= 1024;
        if(isMobile) window.abrirFormularioMobile();
        else window.scrollToId('areaFormulario');
    }

    window.remover = (tipo, i) => { 
        if(confirm("Excluir?")){ 
            window.dadosPorMes[window.mesAtual][tipo].splice(i,1); 
            window.salvar(); window.render(); 
        } 
    }
    
    window.toggle = (tipo, i) => { 
        window.dadosPorMes[window.mesAtual][tipo][i].marcado = !window.dadosPorMes[window.mesAtual][tipo][i].marcado; 
        window.salvar(); window.render(); 
    }

    window.toggleCategoriaRow = (tipo, idSafe) => {
        window.categoriasExpandidas[tipo][idSafe] = !window.categoriasExpandidas[tipo][idSafe];
        window.render(); 
    }

    window.calcularTotalReservaAcumulado = () => {
        let total = 0;
        Object.keys(window.dadosPorMes).forEach(mesKey => {
            const mesDados = window.dadosPorMes[mesKey];
            if(mesDados.pagar) {
                mesDados.pagar.forEach(i => { if(i.marcado && i.categoria === 'Reserva') total += i.valor; });
            }
            if(mesDados.receber) {
                mesDados.receber.forEach(i => { if(i.marcado && i.categoria === 'Resgate Reserva') total -= i.valor; });
            }
        });
        return total;
    }

    // RENDERIZA√á√ÉO
    window.render = () => {
        window.garantirMes();
        const tRec = document.getElementById('tabelaReceber'); 
        const tPag = document.getElementById('tabelaPagar');
        let totalRec = 0, totalPag = 0, urgente = false;
        const hoje = new Date().toISOString().split('T')[0];

        ['receber', 'pagar'].forEach(tipo => {
            const categoriasGroup = {};
            let pendentesTotaisDoTipo = 0;
            
            window.dadosPorMes[window.mesAtual][tipo].forEach((item, idx) => {
                const itemWithIdx = {...item, idxOriginal: idx};
                if (!categoriasGroup[item.categoria]) categoriasGroup[item.categoria] = { total: 0, items: [], pendentes: 0 };
                
                categoriasGroup[item.categoria].items.push(itemWithIdx);
                categoriasGroup[item.categoria].total += item.valor;
                
                if(item.marcado) { 
                    if(tipo === 'receber') totalRec += item.valor; else totalPag += item.valor; 
                } else {
                    categoriasGroup[item.categoria].pendentes++;
                    pendentesTotaisDoTipo++;
                }

                const atrasado = (tipo === 'pagar' && !item.marcado && item.data && item.data < hoje);
                if(atrasado) urgente = true;
            });

            const iconeTitulo = tipo === 'receber' ? '<i class="fas fa-arrow-down"></i>' : '<i class="fas fa-arrow-up"></i>';
            const nomeTitulo = tipo === 'receber' ? 'Entradas' : 'Sa√≠das';
            const badgeTitulo = pendentesTotaisDoTipo > 0 ? `<span class="badge-pendente"><i class="fas fa-exclamation-circle"></i> ${pendentesTotaisDoTipo} pendente(s)</span>` : '';
            
            if (tipo === 'receber') document.getElementById('tituloReceber').innerHTML = `${iconeTitulo} ${nomeTitulo} ${badgeTitulo}`;
            else document.getElementById('tituloPagar').innerHTML = `${iconeTitulo} ${nomeTitulo} ${badgeTitulo}`;

            const catKeys = Object.keys(categoriasGroup).sort((a,b) => categoriasGroup[b].total - categoriasGroup[a].total);
            let html = '';
            
            catKeys.forEach(cat => {
                const idSafe = cat.replace(/[^a-zA-Z0-9]/g, '');
                const isExpanded = window.categoriasExpandidas[tipo][idSafe] || false;
                const displayRow = isExpanded ? 'table-row' : 'none';
                const iconRot = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
                const corBorda = tipo === 'receber' ? 'var(--success)' : 'var(--danger)';
                const badgeCategoria = categoriasGroup[cat].pendentes > 0 ? `<i class="fas fa-circle dot-pendente" title="H√° itens pendentes"></i>` : '';

                html += `
                    <tr class="row-category" onclick="toggleCategoriaRow('${tipo}', '${idSafe}')" style="border-left: 3px solid ${corBorda};">
                        <td style="font-weight:600; color:var(--text-dark);">
                            <div class="cat-title-wrapper">
                                <i class="fas fa-chevron-right" style="font-size:0.7rem; transition:0.3s; transform:${iconRot}"></i>
                                <span>${cat}</span>
                                <span style="font-size:0.75rem; color:var(--text-light); font-weight:normal;">(${categoriasGroup[cat].items.length})</span>
                                ${badgeCategoria}
                            </div>
                        </td>
                        <td style="font-weight:700; text-align:right;">${formatar(categoriasGroup[cat].total)}</td>
                        <td></td><td></td><td></td>
                    </tr>
                `;

                categoriasGroup[cat].items.sort((a,b) => (a.data > b.data ? 1 : -1));

                categoriasGroup[cat].items.forEach(item => {
                    const i = item.idxOriginal;
                    const atrasado = (tipo === 'pagar' && !item.marcado && item.data && item.data < hoje);
                    html += `
                        <tr style="display:${displayRow}; background: rgba(0,0,0,0.01);">
                            <td style="padding-left: 28px;">
                                <span class="desc-text ${atrasado ? 'vencido' : ''}" style="font-size: 0.8rem; color: var(--text-light);">
                                    ${atrasado ? '‚ö†Ô∏è ' : ''}${item.descricao}
                                </span>
                            </td>
                            <td style="text-align:right; font-size:0.8rem;">${formatar(item.valor)}</td>
                            <td style="font-size:0.8rem; text-align:center;">${item.data ? item.data.split('-').reverse().slice(0,2).join('/') : '-'}</td>
                            <td style="text-align:center;"><input type="checkbox" class="custom-check" ${item.marcado ? 'checked' : ''} onclick="toggle('${tipo}', ${i})"></td>
                            <td style="text-align:right;">
                                <button class="btn-action btn-edit" onclick="prepararEdicao('${tipo}', ${i})"><i class="fas fa-pen"></i></button>
                                <button class="btn-action btn-del" onclick="remover('${tipo}', ${i})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            });

            if(tipo === 'receber') tRec.innerHTML = html; else tPag.innerHTML = html;
        });

        const totalReservaAcumulado = window.calcularTotalReservaAcumulado();
        document.getElementById('bannerAlerta').style.display = urgente ? 'block' : 'none';
        animarValor('totalRecebido', totalRec); 
        animarValor('totalPago', totalPag); 
        animarValor('totalReserva', totalReservaAcumulado); 
        animarValor('saldo', totalRec - totalPag);
        atualizarGrafico();
    }

    let chartSidebar = null; let chartMobile = null;
    window.atualizarGrafico = () => {
        const resumo = {}; 
        window.dadosPorMes[window.mesAtual].pagar.forEach(item => { if(item.marcado) resumo[item.categoria] = (resumo[item.categoria] || 0) + item.valor; });
        const chartConfig = { type: 'doughnut', data: { labels: Object.keys(resumo), datasets: [{ data: Object.values(resumo), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#14b8a6'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; if (context.raw !== null) label += context.raw.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); return label; } } } } } };

        const ctxSide = document.getElementById('graficoSidebar'); if(chartSidebar) chartSidebar.destroy();
        if(ctxSide && Object.keys(resumo).length > 0) chartSidebar = new Chart(ctxSide, chartConfig);

        const ctxMob = document.getElementById('graficoMobile'); if(chartMobile) chartMobile.destroy();
        if(ctxMob && Object.keys(resumo).length > 0) chartMobile = new Chart(ctxMob, chartConfig);
    }
    
    // Configura√ß√µes de Mensagens
    const msgsCategoria = {
        'Filho': "Os gastos com os pequenos est√£o no topo! Cuidar deles √© prioridade.",
        'Supermercado': "O supermercado levou a maior fatia do or√ßamento. Fazer uma lista rigorosa ajuda!",
        'Alimenta√ß√£o': "Comer fora ou pedir delivery pesou bastante. Tente cozinhar mais em casa.",
        'Lazer': "Voc√™ curtiu bastante esse m√™s! Defina um teto m√°ximo para o lazer.",
        'Transporte': "Gastos com transporte est√£o altos. Avalie rotas ou alternativas.",
        'Sa√∫de': "A sa√∫de cobrou seu pre√ßo. Lembre-se que bem-estar √© investimento.",
        'Moradia': "Sua casa √© o maior custo. Revise planos de internet e energia.",
        'Credito': "Cuidado com o cart√£o de cr√©dito e juros!",
        'Assinaturas': "Muitos streamings? Cancele o que n√£o usa.",
        'default': "Fique de olho nesta categoria! Ela foi a campe√£ de gastos."
    };

    window.abrirRelatorioCard = (tipo) => {
        window.garantirMes();
        const corpo = document.getElementById('corpoRelatorio');
        const titulo = document.getElementById('modalRelatorioTitulo');
        corpo.innerHTML = '';
        
        let total = 0;
        
        if (tipo === 'receber') {
            titulo.innerText = "üü¢ Resumo de Recebimentos";
            const recebidos = window.dadosPorMes[window.mesAtual].receber.filter(i => i.marcado);
            recebidos.forEach(i => total += i.valor);
            
            corpo.innerHTML += `
                <div class="insight-card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);">
                    <div class="insight-icon" style="background: var(--success); color: white;"><i class="fas fa-hand-holding-usd"></i></div>
                    <div>
                        <h4 style="margin:0; color: var(--text-dark);">Mandou muito bem!</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-light);">
                            Voc√™ j√° garantiu <strong>${formatar(total)}</strong> neste m√™s. Continue focando em aumentar suas fontes de renda!
                        </p>
                    </div>
                </div>
                <h4 style="margin-bottom:10px; color: var(--text-light); text-transform:uppercase; font-size:0.8rem;">Todas as Entradas Realizadas</h4>
            `;
            recebidos.forEach(item => {
                const data = item.data ? item.data.split('-').reverse().join('/') : '-';
                corpo.innerHTML += `<div class="item-list"><span>${data} - ${item.descricao}</span><span style="font-weight:bold; color:var(--success)">${formatar(item.valor)}</span></div>`;
            });
            
        } else if (tipo === 'pagar') {
            titulo.innerText = "üî¥ Resumo de Sa√≠das";
            const totaisCat = {};
            const pagos = window.dadosPorMes[window.mesAtual].pagar.filter(i => i.marcado);
            pagos.forEach(i => { total += i.valor; totaisCat[i.categoria] = (totaisCat[i.categoria] || 0) + i.valor; });

            let topCat = ''; let maxVal = 0;
            for(let c in totaisCat) { if(totaisCat[c] > maxVal) { maxVal = totaisCat[c]; topCat = c; } }
            let msgPersonalizada = msgsCategoria[topCat] || msgsCategoria['default'];

            if (maxVal > 0) {
                corpo.innerHTML += `
                    <div class="insight-card" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div class="insight-icon" style="background: var(--danger); color: white;"><i class="fas fa-exclamation-triangle"></i></div>
                        <div>
                            <h4 style="margin:0; color: var(--text-dark);">Maior Gasto: ${topCat}</h4>
                            <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--text-light);">
                                Voc√™ gastou <strong>${formatar(maxVal)}</strong> com isso.<br> ${msgPersonalizada}
                            </p>
                        </div>
                    </div>
                `;
            }
            corpo.innerHTML += `<h4 style="margin-bottom:10px; color: var(--text-light); text-transform:uppercase; font-size:0.8rem;">Todas as Sa√≠das Realizadas</h4>`;
            pagos.forEach(item => {
                 const data = item.data ? item.data.split('-').reverse().join('/') : '-';
                 corpo.innerHTML += `<div class="item-list"><span>${data} - ${item.descricao}</span><span style="font-weight:bold; color:var(--danger)">${formatar(item.valor)}</span></div>`;
            });
            
        } else if (tipo === 'reserva') {
            titulo.innerText = "üí∞ Detalhes da Reserva";
            const totalAcumulado = window.calcularTotalReservaAcumulado();
            let aportesMes = 0; window.dadosPorMes[window.mesAtual].pagar.filter(i => i.marcado && i.categoria === 'Reserva').forEach(i => aportesMes += i.valor);
            let resgatesMes = 0; window.dadosPorMes[window.mesAtual].receber.filter(i => i.marcado && i.categoria === 'Resgate Reserva').forEach(i => resgatesMes += i.valor);

            corpo.innerHTML += `
                <div class="insight-card" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div class="insight-icon" style="background: var(--warning); color: white;"><i class="fas fa-piggy-bank"></i></div>
                    <div>
                        <h4 style="margin:0; color: var(--text-dark);">Saldo Total Guardado</h4>
                        <p style="margin: 5px 0 0 0; font-size: 1.2rem; font-weight:bold; color: var(--warning);">
                            ${formatar(totalAcumulado)}
                        </p>
                    </div>
                </div>

                <div style="background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed rgba(0,0,0,0.1);">
                    <label style="display:block; margin-bottom:5px; font-weight:600; font-size:0.9rem;">Nova Movimenta√ß√£o</label>
                    <input id="inputValorReserva" type="number" placeholder="Valor (R$)" style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px;">
                         <button class="btn-green" onclick="realizarTransacaoReserva('depositar')"><i class="fas fa-plus-circle"></i> Guardar</button>
                         <button class="btn-red" onclick="realizarTransacaoReserva('sacar')"><i class="fas fa-minus-circle"></i> Resgatar</button>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding:10px; background:var(--glass-bg); border-radius:8px;">
                     <span>Movimenta√ß√£o do M√™s:</span>
                     <span style="font-weight:bold;">+${formatar(aportesMes)} / -${formatar(resgatesMes)}</span>
                </div>
            `;

        } else if (tipo === 'saldo') {
            titulo.innerText = "‚öñÔ∏è Balan√ßo Dispon√≠vel";
            let totalRec = 0; window.dadosPorMes[window.mesAtual].receber.filter(i=>i.marcado).forEach(i=>totalRec += i.valor);
            let totalPag = 0; window.dadosPorMes[window.mesAtual].pagar.filter(i=>i.marcado).forEach(i=>totalPag += i.valor);
            let saldoFinal = totalRec - totalPag;
            const reservaTotal = window.calcularTotalReservaAcumulado();

            corpo.innerHTML += `
                <div style="background: var(--card-bg); border-radius: 12px; padding: 15px; border: 1px solid var(--border-color);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>Saldo Dispon√≠vel (Carteira):</span> <span style="font-weight:bold; font-size:1.1rem; color:var(--info)">${formatar(saldoFinal)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:10px;">
                        <span>Guardado na Reserva:</span> <span style="font-weight:bold; color:var(--warning)">${formatar(reservaTotal)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold;">
                        <span>Patrim√¥nio Total:</span> <span style="color:var(--success)">${formatar(saldoFinal + reservaTotal)}</span>
                    </div>
                    <p style="font-size:0.8rem; color:var(--text-light); text-align:center; margin-top:10px;">* O saldo dispon√≠vel j√° teve os valores da reserva descontados.</p>
                </div>
            `;
        }
        document.getElementById('modalRelatorio').style.display = 'flex';
    }

    window.gerarRelatorioDiario = () => {
        window.garantirMes();
        let totalEntradasOk = 0, totalSaidasOk = 0, totalEntradasGeral = 0, totalSaidasGeral = 0;
        window.dadosPorMes[window.mesAtual].receber.forEach(item => { totalEntradasGeral += item.valor; if (item.marcado) totalEntradasOk += item.valor; });
        window.dadosPorMes[window.mesAtual].pagar.forEach(item => { totalSaidasGeral += item.valor; if (item.marcado) totalSaidasOk += item.valor; });

        const saldoGeral = totalEntradasGeral - totalSaidasGeral; 
        const diferencaOk = totalEntradasOk - totalSaidasOk; 
        const corBalanco = saldoGeral >= 0 ? '#10b981' : '#ef4444'; const corRealizado = diferencaOk >= 0 ? '#10b981' : '#ef4444'; 

        let msgMotivacional = "";
        if (diferencaOk > 2000) msgMotivacional = "üöÄ <strong>Caixa Forte!</strong> Seu saldo real est√° excelente.";
        else if (diferencaOk > 500) msgMotivacional = "üëè <strong>No Azul!</strong> Voc√™ tem dinheiro sobrando.";
        else if (diferencaOk > 0) msgMotivacional = "üòÖ <strong>Positivo, mas cuidado!</strong>";
        else msgMotivacional = "‚ö†Ô∏è <strong>Alerta de Caixa!</strong>";

        const corpo = document.getElementById('corpoRelatorio');
        document.getElementById('modalRelatorioTitulo').innerText = "üìä Relat√≥rio Financeiro Global";
        
        corpo.innerHTML = `
            <div style="background: rgba(0,0,0,0.02); border-left: 5px solid ${corBalanco}; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05);">
                <h4 style="margin: 0 0 10px 0; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">üìä Previs√£o Geral (Lan√ßado)</h4>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px;">
                    <span>Total Lan√ßado:</span><span style="font-weight: bold;">${formatar(totalEntradasGeral)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px;">
                    <span>Sa√≠das Lan√ßadas:</span><span style="font-weight: bold; color: var(--danger);">${formatar(totalSaidasGeral)}</span>
                </div>
                <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px; display: flex; justify-content: space-between; font-weight: bold;">
                    <span>Saldo Final Previsto:</span><span style="color: ${corBalanco}">${formatar(saldoGeral)}</span>
                </div>
            </div>
            <div style="background: rgba(0,0,0,0.02); border-left: 5px solid ${corRealizado}; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05);">
                <h4 style="margin: 0 0 5px 0; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">üí° Realizado at√© agora (Pago/Recebido)</h4>
                <p style="margin: 0; font-size: 0.95rem; color: var(--text-dark);">
                    ${diferencaOk >= 0 ? '‚úÖ Seu caixa est√° positivo em ' : '‚ö†Ô∏è Voc√™ gastou ' + formatar(Math.abs(diferencaOk)) + ' a mais do que recebeu '} 
                    <strong>${formatar(diferencaOk)}</strong>.
                </p>
            </div>
            <div style="background: ${corRealizado}15; border-left: 5px solid ${corRealizado}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.9rem; color: var(--text-dark); line-height: 1.4;">${msgMotivacional}</p>
            </div>
        `;
        document.getElementById('modalRelatorio').style.display = 'flex';
    }

    window.exportarDados = () => { const blob = new Blob([JSON.stringify(window.dadosPorMes)], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "financeiro_blush.json"; a.click(); }
    window.importarDados = (e) => { const reader = new FileReader(); reader.onload = (ev) => { window.dadosPorMes = JSON.parse(ev.target.result); window.salvar(); window.render(); alert("Restaurado!"); }; reader.readAsText(e.target.files[0]); }
    
    // Resize Listener
    window.onresize = () => {
       const isMobile = window.innerWidth <= 1024;
       document.getElementById('navMobile').style.display = isMobile ? 'flex' : 'none';
       document.querySelector('.sidebar').classList.toggle('d-lg-flex', !isMobile);
    }

</script>
</body>
</html>
