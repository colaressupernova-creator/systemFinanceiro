<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RE Solution - Financeiro Blush</title>

<meta name="theme-color" content="#6366f1">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root {
    /* Paleta Blush */
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    --glass-bg: rgba(255, 255, 255, 0.65);
    --glass-border: 1px solid rgba(255, 255, 255, 0.5);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    
    --text-dark: #1e293b;
    --text-light: #64748b;
    
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;

    /* Inputs */
    --input-bg: rgba(255, 255, 255, 0.6);
  }

  /* Dark Mode Variables */
  body.dark-mode {
    --text-dark: #f1f5f9;
    --text-light: #cbd5e1;
    --glass-bg: rgba(15, 23, 42, 0.6);
    --glass-border: 1px solid rgba(255, 255, 255, 0.1);
    --input-bg: rgba(0, 0, 0, 0.3);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body { 
    font-family: 'Poppins', sans-serif; 
    margin: 0; 
    display: flex; 
    height: 100vh; 
    color: var(--text-dark); 
    overflow: hidden; 
    
    /* Fundo Animado Blush */
    background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
    background-size: 400% 400%;
    animation: blushAnimation 15s ease infinite;
    transition: background 0.5s;
  }
  
  body.dark-mode {
    background: linear-gradient(-45deg, #1e1b4b, #312e81, #4c1d95, #1e1b4b);
    background-size: 400% 400%;
    animation: blushAnimation 15s ease infinite;
  }

  @keyframes blushAnimation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* --- SIDEBAR (Desktop) --- */
  .sidebar { 
    width: 280px; 
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-right: var(--glass-border);
    display: flex; flex-direction: column; 
    padding: 25px; flex-shrink: 0; z-index: 100;
    overflow-y: auto;
  }
  body.dark-mode .sidebar { background: rgba(15, 23, 42, 0.8); }

  .logo { 
    font-size: 1.5rem; font-weight: 700; margin-bottom: 30px; 
    background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    display: flex; align-items: center; gap: 10px; 
  }

  .sidebar-section { margin-bottom: 25px; }
  .sidebar-label { font-size: 0.75rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 0.5px; }

  /* --- MAIN CONTENT --- */
  .main-content { flex: 1; padding: 30px; overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth; }
  
  /* --- CARDS & GLASS --- */
  .card { 
    background: var(--glass-bg);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-radius: 20px; padding: 25px; 
    box-shadow: var(--glass-shadow); border: var(--glass-border);
    margin-bottom: 20px; position: relative; overflow: hidden;
  }
  
  /* Indicador lateral colorido nos cards de totais */
  .card.border-l { padding-left: 25px; }
  .card.border-l::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
  .card.border-success::before { background: var(--success); }
  .card.border-danger::before { background: var(--danger); }
  .card.border-primary::before { background: var(--info); }

  .dash-value { font-size: 1.8rem; font-weight: 700; margin-top: 5px; }
  
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

  /* --- INPUTS & BUTTONS --- */
  input, select { 
    width: 100%; padding: 12px 15px; border: 1px solid rgba(255,255,255,0.4); border-radius: 12px; 
    font-size: 0.95rem; background: var(--input-bg); color: var(--text-dark); outline: none; transition: 0.3s;
    font-family: 'Poppins', sans-serif;
  }
  input:focus, select:focus { background: rgba(255,255,255,0.9); border-color: #a855f7; box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2); }
  
  button { 
    padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; 
    display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; transition: 0.3s; 
    font-family: 'Poppins', sans-serif;
  }
  button:active { transform: scale(0.96); }
  
  .btn-primary { background: var(--primary-gradient); color: white; width: 100%; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
  .btn-outline { background: transparent; border: 1px solid var(--text-light); color: var(--text-light); width: 100%; margin-bottom: 5px; }
  .btn-outline:hover { background: rgba(255,255,255,0.2); border-color: var(--text-dark); color: var(--text-dark); }
  
  .btn-action { width: 32px; height: 32px; padding: 0; border-radius: 8px; font-size: 0.9rem; }
  .btn-edit { color: var(--warning); background: rgba(245, 158, 11, 0.1); }
  .btn-del { color: var(--danger); background: rgba(239, 68, 68, 0.1); }

 /* --- TABELA AJUSTADA PARA N√ÉO ROLAR --- */
  .table-box { 
      width: 100%; 
      overflow-x: hidden; /* Remove a rolagem lateral for√ßada */
  }

  table { 
      width: 100%; 
      border-collapse: collapse; 
      table-layout: fixed; /* OBRIGAT√ìRIO: For√ßa a tabela a caber na largura dispon√≠vel */
  }

  th { 
      text-align: left; 
      padding: 10px 5px; /* Menos padding */
      color: #8b5cf6; 
      font-size: 0.7rem; 
      text-transform: uppercase; 
      font-weight: 700; 
      border-bottom: 2px solid rgba(0,0,0,0.05); 
  }

  td { 
      padding: 10px 5px; /* Menos padding */
      border-bottom: 1px solid rgba(0,0,0,0.05); 
      color: var(--text-dark); 
      font-size: 0.85rem;
      vertical-align: middle;
  }
  
  /* --- LARGURAS DAS COLUNAS --- */
  
  /* 1. Descri√ß√£o (Ganha o espa√ßo que sobrar) */
  th:nth-child(1), td:nth-child(1) {
      width: auto; 
  }
  
  /* Texto da descri√ß√£o cortado com "..." se for muito longo */
  td:nth-child(1) span {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px; /* Limite de largura no celular */
  }

  /* 2. Valor (Fixo) */
  th:nth-child(2), td:nth-child(2) {
      width: 25%; 
      text-align: right;
  }

  /* 3. Data (Esconder em celulares pequenos para caber os bot√µes) */
  th:nth-child(3), td:nth-child(3) {
      width: 15%;
      text-align: center;
  }
  
  @media (max-width: 400px) {
      th:nth-child(3), td:nth-child(3) {
          display: none; /* Some com a data em telas muito pequenas */
      }
  }

  /* 4. Checkbox (Bem pequeno) */
  th:nth-child(4), td:nth-child(4) {
      width: 40px;
      text-align: center;
  }

  /* 5. A√ß√µes (Bot√µes) */
  th:nth-child(5), td:nth-child(5) {
      width: 70px; /* Espa√ßo suficiente para os 2 bot√µes */
      text-align: right;
  }

  /* Bot√µes de A√ß√£o menores */
  .btn-action { 
      width: 28px; 
      height: 28px; 
      font-size: 0.8rem; 
      margin-left: 2px;
  }
  
  /* Checkbox customizado */
  .custom-check { appearance: none; width: 20px; height: 20px; border: 2px solid var(--text-light); border-radius: 6px; cursor: pointer; position: relative; }
  .custom-check:checked { background: var(--success); border-color: var(--success); }
  .custom-check:checked::after { content: '‚úî'; color: white; position: absolute; font-size: 14px; top: -2px; left: 3px; }

  /* --- MODAL --- */
  .modal-overlay { 
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px); z-index: 2000; 
    align-items: center; justify-content: center; 
  }
  .modal-content { 
    background: #fff; width: 90%; max-width: 450px; border-radius: 24px; 
    overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.2); 
    display: flex; flex-direction: column; max-height: 85vh; 
  }
  body.dark-mode .modal-content { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); }

  .modal-header { 
    background: var(--primary-gradient); color: white; padding: 20px; 
    display: flex; justify-content: space-between; align-items: center; 
  }
  .modal-body { padding: 20px; overflow-y: auto; }

  /* --- BANNER ALERTA --- */
  #bannerAlerta { 
    display: none; background: rgba(239, 68, 68, 0.9); backdrop-filter: blur(5px);
    color: white; text-align: center; padding: 10px; font-weight: 600; font-size: 0.9rem;
    position: fixed; top: 0; left: 0; right: 0; z-index: 200;
  }

  /* =========================================
     MOBILE (BARRA INFERIOR)
     ========================================= */
  @media (max-width: 1024px) {
    body { flex-direction: column; }
    
    .sidebar { display: none; } /* Esconde sidebar normal */

    .main-content { padding: 20px; padding-bottom: 90px; }
    .grid-3, .grid-2 { grid-template-columns: 1fr; gap: 15px; }

    /* Barra Inferior de Navega√ß√£o */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      display: flex; justify-content: space-around; align-items: center;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid rgba(255,255,255,0.5);
      z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
    }
    body.dark-mode .bottom-nav { background: rgba(30, 41, 59, 0.9); }

    .nav-btn {
      background: none; border: none; color: var(--text-light);
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      font-size: 0.7rem; cursor: pointer; padding: 5px; flex: 1;
    }
    .nav-btn i { font-size: 1.4rem; transition: 0.2s; }
    .nav-btn span { font-weight: 500; }
    
    .nav-btn:active i { transform: scale(0.9); color: #8b5cf6; }
    
    /* Bot√£o Central (Adicionar) Flutuante */
    .nav-btn-main {
      background: var(--primary-gradient); color: white;
      width: 50px; height: 50px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin-top: -30px; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
      border: 4px solid rgba(255,255,255,0.8);
    }
    body.dark-mode .nav-btn-main { border-color: #1e1b4b; }
    .nav-btn-main i { font-size: 1.5rem; }
  }

  /* Utility classes */
  .text-success { color: var(--success); }
  .text-danger { color: var(--danger); }
  .vencido { color: var(--danger); font-weight: 700; }
</style>
</head>
<body>

<div id="bannerAlerta">üîî ATEN√á√ÉO: Contas vencidas ou vencendo hoje!</div>

<div class="sidebar d-none d-lg-flex">
  <div class="logo"><i class="fas fa-wallet"></i> <span>RE Solution</span></div>
  
  <div class="sidebar-section">
    <div class="sidebar-label">M√™s de Refer√™ncia</div>
    <select id="mes" onchange="mudarMes()">
      <option value="2026-01">Janeiro/2026</option>
      <option value="2026-02">Fevereiro/2026</option>
      <option value="2026-03">Mar√ßo/2026</option>
      <option value="2026-04">Abril/2026</option>
      <option value="2026-05">Maio/2026</option>
      <option value="2026-06">Junho/2026</option>
      <option value="2026-07">Julho/2026</option>
      <option value="2026-08">Agosto/2026</option>
      <option value="2026-09">Setembro/2026</option>
      <option value="2026-10">Outubro/2026</option>
      <option value="2026-11">Novembro/2026</option>
      <option value="2026-12">Dezembro/2026</option>
    </select>
  </div>

  <div class="sidebar-section">
    <div class="sidebar-label">Resumo Visual</div>
    <div style="height: 180px; position: relative;">
      <canvas id="graficoPizza"></canvas>
    </div>
  </div>

  <div class="sidebar-section" style="margin-top:auto;">
    <div class="sidebar-label">Sistema</div>
    <button class="btn-outline" onclick="gerarRelatorioDiario()"><i class="fas fa-chart-line"></i> Relat√≥rio</button>
    <button class="btn-outline" onclick="exportarDados()"><i class="fas fa-file-export"></i> Backup</button>
    <button class="btn-outline" onclick="toggleDarkMode()"><i class="fas fa-adjust"></i> Tema</button>
    <button class="btn-outline" onclick="document.getElementById('inputImport').click()"><i class="fas fa-file-import"></i> Restaurar</button>
    <input type="file" id="inputImport" style="display:none" onchange="importarDados(event)">
  </div>
</div>

<main class="main-content" id="top">
  
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div>
      <h2 style="margin:0; font-size: 1.5rem;">Vis√£o Geral</h2>
      <span id="labelMesAtivo" style="color: var(--text-light); font-weight: 500;">Carregando...</span>
    </div>
    <button class="btn-action" style="background: var(--glass-bg); width: 40px; height: 40px;" onclick="abrirConfigMobile()" id="btnMobileMenu">
      <i class="fas fa-cog"></i>
    </button>
  </div>

  <div class="grid-3">
    <div class="card border-l border-success">
      <label>Recebido</label>
      <div class="dash-value text-success" id="totalRecebido">R$ 0,00</div>
    </div>
    <div class="card border-l border-danger">
      <label>Pago</label>
      <div class="dash-value text-danger" id="totalPago">R$ 0,00</div>
    </div>
    <div class="card border-l border-primary">
      <label>Saldo</label>
      <div class="dash-value" id="saldo" style="color:#6366f1">R$ 0,00</div>
    </div>
  </div>

  <div id="areaFormulario" class="card" style="margin-top: 20px;">
    <h3 style="margin-top:0; margin-bottom: 15px;">üìù Novo Lan√ßamento</h3>
    <div class="grid-2">
      <div>
        <label>Tipo</label>
        <select id="tipo">
          <option value="pagar">üî¥ Pagar (Sa√≠da)</option>
          <option value="receber">üü¢ Receber (Entrada)</option>
        </select>
      </div>
      <div>
        <label>Categoria</label>
        <select id="categoria">
          <option value="Alimenta√ß√£o">üçî Alimenta√ß√£o</option>
          <option value="Transporte">üöó Transporte</option>
          <option value="Moradia">üè† Moradia</option>
          <option value="Contas">üí° Contas (Luz/√Ågua)</option>
          <option value="Sa√∫de">ü©∫ Sa√∫de</option>
          <option value="Lazer">üéâ Lazer</option>
          <option value="Sal√°rio">üí∞ Sal√°rio</option>
          <option value="Outros">‚öôÔ∏è Outros</option>
        </select>
      </div>
    </div>
    <div class="grid-2">
      <div><label>Descri√ß√£o</label><input id="descricao" placeholder="Ex: Mercado Semanal"></div>
      <div><label>Valor (R$)</label><input id="valor" type="number" step="0.01"></div>
    </div>
    <div style="margin-bottom: 15px;"><label>Data</label><input id="data" type="date"></div>
    <button id="btnSalvar" class="btn-primary" onclick="adicionar()">
      <i class="fas fa-plus-circle"></i> Adicionar Lan√ßamento
    </button>
  </div>

  <div class="grid-2">
    <div class="card">
      <h3 class="text-success" style="margin-top:0"><i class="fas fa-arrow-down"></i> Entradas</h3>
      <div class="table-box">
        <table>
          <thead><tr><th>Desc.</th><th>Valor</th><th>Data</th><th>OK</th><th></th></tr></thead>
          <tbody id="tabelaReceber"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 class="text-danger" style="margin-top:0"><i class="fas fa-arrow-up"></i> Sa√≠das</h3>
      <div class="table-box">
        <table>
          <thead><tr><th>Desc.</th><th>Valor</th><th>Data</th><th>OK</th><th></th></tr></thead>
          <tbody id="tabelaPagar"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="height: 50px;"></div> </main>

<nav class="bottom-nav" id="navMobile">
  <button class="nav-btn" onclick="scrollToId('top')">
    <i class="fas fa-home"></i> <span>In√≠cio</span>
  </button>
  <button class="nav-btn" onclick="gerarRelatorioDiario()">
    <i class="fas fa-chart-pie"></i> <span>Relat√≥rio</span>
  </button>
  
  <button class="nav-btn-main" onclick="scrollToId('areaFormulario')">
    <i class="fas fa-plus"></i>
  </button>
  
  <button class="nav-btn" onclick="abrirConfigMobile()">
    <i class="fas fa-calendar-alt"></i> <span>M√™s</span>
  </button>
  <button class="nav-btn" onclick="toggleDarkMode()">
    <i class="fas fa-adjust"></i> <span>Tema</span>
  </button>
</nav>

<div id="modalConfig" class="modal-overlay" onclick="fecharModalConfig(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">Configura√ß√µes</h3>
      <button onclick="document.getElementById('modalConfig').style.display='none'" style="background:none; border:none; color:white; font-size:1.2rem;">‚úï</button>
    </div>
    <div class="modal-body">
      <label>Selecionar M√™s</label>
      <select id="mesMobile" onchange="mudarMesMobile()" style="margin-bottom: 20px;">
        <option value="2026-01">Janeiro/2026</option>
         <option value="2026-02">Fevereiro/2026</option>
         <option value="2026-03">Mar√ßo/2026</option>
         <option value="2026-04">Abril/2026</option>
         <option value="2026-05">Maio/2026</option>
         <option value="2026-06">Junho/2026</option>
         <option value="2026-07">Julho/2026</option>
         <option value="2026-08">Agosto/2026</option>
         <option value="2026-09">Setembro/2026</option>
         <option value="2026-10">Outubro/2026</option>
         <option value="2026-11">Novembro/2026</option>
         <option value="2026-12">Dezembro/2026</option>
      </select>

      <label>Dados</label>
      <button class="btn-outline" style="color:var(--text-dark); border-color:var(--text-light);" onclick="exportarDados()">Baixar Backup</button>
      <button class="btn-outline" style="color:var(--text-dark); border-color:var(--text-light);" onclick="document.getElementById('inputImport').click()">Restaurar Backup</button>
    </div>
  </div>
</div>

<div id="modalRelatorio" class="modal-overlay" onclick="fecharModalRelatorio(event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">üìä Relat√≥rio Financeiro</h3>
      <button onclick="document.getElementById('modalRelatorio').style.display='none'" style="background:none; border:none; color:white;">‚úï</button>
    </div>
    <div id="corpoRelatorio" class="modal-body"></div>
  </div>
</div>

<script>
// --- L√ìGICA DO SISTEMA ---
let dadosPorMes = JSON.parse(localStorage.getItem('financeiroDados2026') || '{}');
let mesSalvo = localStorage.getItem('mesSelecionado') || '2026-01';
let mesAtual = mesSalvo;
let editandoIndex = null;
let editandoTipo = null;

// Sincroniza selects de m√™s
document.getElementById('mes').value = mesAtual;
if(document.getElementById('mesMobile')) document.getElementById('mesMobile').value = mesAtual;

// Dark Mode Check
if (localStorage.getItem('darkMode') === 'enabled') document.body.classList.add('dark-mode');

// Init
window.onload = () => {
  render();
  atualizarLabelTopo();
  
  // Controle de visibilidade do menu inferior
  const isMobile = window.innerWidth <= 1024;
  if(!isMobile) document.getElementById('navMobile').style.display = 'none';
};

window.onresize = () => {
   const isMobile = window.innerWidth <= 1024;
   document.getElementById('navMobile').style.display = isMobile ? 'flex' : 'none';
   document.querySelector('.sidebar').classList.toggle('d-lg-flex', !isMobile);
}

function scrollToId(id) {
  document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
}

function toggleDarkMode() {
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
  atualizarGrafico(); // Atualiza cores do gr√°fico
}

function salvar(){ localStorage.setItem('financeiroDados2026', JSON.stringify(dadosPorMes)); }
function garantirMes(){ if(!dadosPorMes[mesAtual]) dadosPorMes[mesAtual] = { receber: [], pagar: [] }; }
function formatar(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }

function atualizarLabelTopo() {
    const select = document.getElementById('mes');
    const texto = select.options[select.selectedIndex].text;
    document.getElementById('labelMesAtivo').innerText = texto;
}

function mudarMes() {
    mesAtual = document.getElementById('mes').value;
    localStorage.setItem('mesSelecionado', mesAtual);
    // Sincroniza mobile
    if(document.getElementById('mesMobile')) document.getElementById('mesMobile').value = mesAtual;
    atualizarLabelTopo();
    render();
}

function mudarMesMobile() {
    mesAtual = document.getElementById('mesMobile').value;
    document.getElementById('mes').value = mesAtual;
    mudarMes();
    document.getElementById('modalConfig').style.display = 'none';
}

function abrirConfigMobile() { document.getElementById('modalConfig').style.display = 'flex'; }
function fecharModalConfig(e) { if(e.target.id === 'modalConfig') e.target.style.display = 'none'; }
function fecharModalRelatorio(e) { if(e.target.id === 'modalRelatorio') e.target.style.display = 'none'; }

// --- CRUD ---
function adicionar(){
    const tipo = document.getElementById('tipo').value;
    const descricao = document.getElementById('descricao').value;
    const valor = Number(document.getElementById('valor').value);
    const data = document.getElementById('data').value;
    const categoria = document.getElementById('categoria').value;
    
    if(!descricao || !valor) return alert("Preencha descri√ß√£o e valor");
    
    garantirMes();
    const item = {descricao, valor, data, categoria, marcado: false};
    
    if(editandoIndex !== null) {
        item.marcado = dadosPorMes[mesAtual][editandoTipo][editandoIndex].marcado;
        dadosPorMes[mesAtual][editandoTipo][editandoIndex] = item;
    } else {
        dadosPorMes[mesAtual][tipo].push(item);
    }
    
    editandoIndex = null;
    document.getElementById('btnSalvar').innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Lan√ßamento';
    document.getElementById('descricao').value = ''; document.getElementById('valor').value = '';
    
    salvar(); render();
}

function prepararEdicao(tipo, index){
    editandoIndex = index; editandoTipo = tipo;
    const item = dadosPorMes[mesAtual][tipo][index];
    document.getElementById('tipo').value = tipo;
    document.getElementById('descricao').value = item.descricao;
    document.getElementById('valor').value = item.valor;
    document.getElementById('data').value = item.data;
    document.getElementById('categoria').value = item.categoria;
    document.getElementById('btnSalvar').innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√£o';
    scrollToId('areaFormulario');
}

function remover(tipo, i){ if(confirm("Excluir?")){ dadosPorMes[mesAtual][tipo].splice(i,1); salvar(); render(); } }

function toggle(tipo, i) {
    dadosPorMes[mesAtual][tipo][i].marcado = !dadosPorMes[mesAtual][tipo][i].marcado;
    salvar(); render(); 
}

// --- RENDER ---
function render() {
    garantirMes();
    const tRec = document.getElementById('tabelaReceber');
    const tPag = document.getElementById('tabelaPagar');
    tRec.innerHTML = ''; tPag.innerHTML = '';

    let totalRec = 0, totalPag = 0, urgente = false;
    const hoje = new Date().toISOString().split('T')[0];

    ['receber', 'pagar'].forEach(tipo => {
        const lista = dadosPorMes[mesAtual][tipo].map((item, idx) => ({...item, idxOriginal: idx}))
                      .sort((a,b) => (a.data > b.data ? 1 : -1));

        lista.forEach(item => {
            const i = item.idxOriginal;
            if(item.marcado) {
               if(tipo === 'receber') totalRec += item.valor;
               else totalPag += item.valor;
            }

            const atrasado = (tipo === 'pagar' && !item.marcado && item.data && item.data < hoje);
            if(atrasado) urgente = true;

            // Dentro do loop forEach na fun√ß√£o render():

const html = `
    <tr>
        <td>
            <span class="${atrasado ? 'vencido' : ''}" style="display:block; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                ${atrasado ? '‚ö†Ô∏è ' : ''}${item.descricao}
            </span>
            <div style="font-size:0.7rem; color:var(--text-light);">${item.categoria}</div>
        </td>
        
        <td style="font-weight:600; text-align:right;">${formatar(item.valor)}</td>
        
        <td style="font-size:0.75rem; text-align:center;">
            ${item.data ? item.data.split('-').reverse().slice(0,2).join('/') : '-'}
        </td>
        
        <td style="text-align:center;">
            <input type="checkbox" class="custom-check" ${item.marcado ? 'checked' : ''} onclick="toggle('${tipo}', ${i})">
        </td>
        
        <td style="text-align:right;">
            <button class="btn-action btn-edit" onclick="prepararEdicao('${tipo}', ${i})"><i class="fas fa-pen"></i></button>
            <button class="btn-action btn-del" onclick="remover('${tipo}', ${i})"><i class="fas fa-trash"></i></button>
        </td>
    </tr>
`;
            if(tipo === 'receber') tRec.innerHTML += html; else tPag.innerHTML += html;
        });
    });

    document.getElementById('bannerAlerta').style.display = urgente ? 'block' : 'none';
    document.getElementById('totalRecebido').innerText = formatar(totalRec);
    document.getElementById('totalPago').innerText = formatar(totalPag);
    document.getElementById('saldo').innerText = formatar(totalRec - totalPag);
    
    atualizarGrafico();
}

// --- CHART.JS ---
let meuGrafico = null;
function atualizarGrafico(){
    const resumo = {};
    dadosPorMes[mesAtual].pagar.forEach(item => {
        if(item.marcado) resumo[item.categoria] = (resumo[item.categoria] || 0) + item.valor;
    });

    const ctx = document.getElementById('graficoPizza');
    if(meuGrafico) meuGrafico.destroy();
    
    // Cores Blush Theme
    const cores = ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444', '#14b8a6'];

    meuGrafico = new Chart(ctx, {
        type: 'doughnut', 
        data: {
            labels: Object.keys(resumo),
            datasets: [{
                data: Object.values(resumo),
                backgroundColor: cores,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false }
            }
        }
    });
}

// --- EXPORT/IMPORT ---
function exportarDados() { 
  const blob = new Blob([JSON.stringify(dadosPorMes)], {type: "application/json"}); 
  const url = URL.createObjectURL(blob); 
  const a = document.createElement('a'); a.href = url; a.download = "financeiro_blush.json"; a.click(); 
}
function importarDados(e) { 
  const reader = new FileReader(); 
  reader.onload = (ev) => { dadosPorMes = JSON.parse(ev.target.result); salvar(); render(); alert("Restaurado!"); }; 
  reader.readAsText(e.target.files[0]); 
}

// --- RELAT√ìRIO ---
// --- RELAT√ìRIO COMPLETO ---
function gerarRelatorioDiario() {
    garantirMes();
    
    // 1. Vari√°veis para o Realizado (Marcado/Pago)
    let totalEntradasOk = 0;
    let totalSaidasOk = 0;
    
    // 2. Vari√°veis para o Planejado (Tudo lan√ßado)
    let totalEntradasGeral = 0;
    let totalSaidasGeral = 0;
    
    const resumoGastos = {}; 

    // Processar Recebimentos
    dadosPorMes[mesAtual].receber.forEach(item => {
        totalEntradasGeral += item.valor;
        if (item.marcado) totalEntradasOk += item.valor;
    });

    // Processar Pagamentos
    dadosPorMes[mesAtual].pagar.forEach(item => {
        totalSaidasGeral += item.valor; 
        
        // Soma no Realizado APENAS se estiver marcado
        if (item.marcado) {
            totalSaidasOk += item.valor;
        }

        // Soma na Lista por Dia INDEPENDENTE de estar marcado (Mostra tudo)
        if (item.data) {
            resumoGastos[item.data] = (resumoGastos[item.data] || 0) + item.valor;
        }
    });

    const saldoGeral = totalEntradasGeral - totalSaidasGeral;
    const diferencaOk = totalEntradasOk - totalSaidasOk; // Saldo Realizado

    // --- DEFINI√á√ÉO DE CORES ---
    const corBalanco = saldoGeral >= 0 ? '#10b981' : '#ef4444'; 
    const corRealizado = diferencaOk >= 0 ? '#10b981' : '#ef4444'; // Cor que a motiva√ß√£o vai seguir

    // --- L√ìGICA DA MENSAGEM (Baseada no Realizado) ---
    let msgMotivacional = "";
    
    if (diferencaOk > 2000) {
        msgMotivacional = "üöÄ <strong>Caixa Forte!</strong> Seu saldo real est√° excelente. √â um √≥timo momento para separar uma parte para investimentos.";
    } else if (diferencaOk > 500) {
        msgMotivacional = "üëè <strong>No Azul!</strong> Voc√™ tem dinheiro em caixa sobrando. Continue controlando para manter essa tranquilidade.";
    } else if (diferencaOk > 0) {
        msgMotivacional = "üòÖ <strong>Positivo, mas cuidado!</strong> Tem dinheiro na conta, mas a margem √© pequena. Evite gastos n√£o planejados agora.";
    } else if (diferencaOk === 0) {
        msgMotivacional = "‚öñÔ∏è <strong>Zerado.</strong> Tudo o que entrou, saiu. Cuidado, qualquer imprevisto pode te levar para o vermelho.";
    } else {
        msgMotivacional = "‚ö†Ô∏è <strong>Alerta de Caixa!</strong> Voc√™ gastou mais do que recebeu at√© agora. Segure as pontas nos pr√≥ximos dias!";
    }

    const corpo = document.getElementById('corpoRelatorio');
    corpo.innerHTML = '';

    // Bloco 1: Balan√ßo Geral (Previsto)
    corpo.innerHTML += `
        <div style="background: rgba(0,0,0,0.02); border-left: 5px solid ${corBalanco}; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 10px 0; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">üìä Balan√ßo Geral (Previsto)</h4>
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px;">
                <span>Total Lan√ßado:</span>
                <span style="font-weight: bold;">${formatar(totalEntradasGeral)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px;">
                <span>Sa√≠das Lan√ßadas:</span>
                <span style="font-weight: bold; color: var(--danger);">${formatar(totalSaidasGeral)}</span>
            </div>
            <div style="border-top: 1px solid rgba(0,0,0,0.1); padding-top: 8px; display: flex; justify-content: space-between; font-weight: bold;">
                <span>Saldo Final Previsto:</span>
                <span style="color: ${corBalanco}">${formatar(saldoGeral)}</span>
            </div>
        </div>
    `;

    // Bloco 2: Realizado at√© agora
    corpo.innerHTML += `
        <div style="background: rgba(0,0,0,0.02); border-left: 5px solid ${corRealizado}; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05);">
            <h4 style="margin: 0 0 5px 0; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">üí° Realizado at√© agora</h4>
            <p style="margin: 0; font-size: 0.95rem; color: var(--text-dark);">
                ${diferencaOk >= 0 ? '‚úÖ Seu caixa est√° positivo em ' : '‚ö†Ô∏è Voc√™ gastou ' + formatar(Math.abs(diferencaOk)) + ' a mais do que recebeu '} 
                <strong>${formatar(diferencaOk)}</strong>.
            </p>
        </div>
    `;

    // Bloco 3: Mensagem Motivacional (Segue corRealizado)
    corpo.innerHTML += `
        <div style="background: ${corRealizado}15; border-left: 5px solid ${corRealizado}; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <p style="margin: 0; font-size: 0.9rem; color: var(--text-dark); line-height: 1.4;">
                ${msgMotivacional}
            </p>
        </div>
        
        <h4 style="margin: 0 0 10px 0; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">üìÖ Todos os Lan√ßamentos por Dia</h4>
    `;

    // Bloco 4: Detalhamento Di√°rio
    const datasOrdenadas = Object.keys(resumoGastos).sort();
    if (datasOrdenadas.length === 0) {
        corpo.innerHTML += '<p style="text-align:center; color:var(--text-light); font-size: 0.9rem;">Nenhum gasto lan√ßado para este m√™s.</p>';
    } else {
        datasOrdenadas.forEach(data => {
            const dataFormatada = data.split('-').reverse().join('/');
            corpo.innerHTML += `
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed rgba(0,0,0,0.1);">
                    <span style="font-weight:600; color:var(--text-light);">${dataFormatada}</span>
                    <span style="font-weight:700; color:var(--danger);">${formatar(resumoGastos[data])}</span>
                </div>
            `;
        });
    }

    document.getElementById('modalRelatorio').style.display = 'flex';
}
</script>
</body>
</html>
